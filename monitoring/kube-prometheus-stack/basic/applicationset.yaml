apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  generators:
  - clusters:
      selector:
        matchLabels:
          monitoring: enabled
  template:
    metadata:
      name: '{{name}}-monitoring'
      annotations:
        argocd.argoproj.io/sync-wave: "1"
    spec:
      project: default
      source:
        repoURL: https://prometheus-community.github.io/helm-charts
        chart: kube-prometheus-stack
        targetRevision: 55.5.0
        helm:
          releaseName: prometheus
          values: |
            # Basic production-ready values
            prometheus:
              prometheusSpec:
                retention: 30d
                retentionSize: 50GiB
                storageSpec:
                  volumeClaimTemplate:
                    spec:
                      accessModes: ["ReadWriteOnce"]
                      resources:
                        requests:
                          storage: 50Gi
            
            grafana:
              adminPassword: ""  # Generates random 40-char password          
              persistence:
                enabled: true
                size: 10Gi
              
              dashboardProviders:
                dashboardproviders.yaml:
                  apiVersion: 1
                  providers:
                  - name: 'default'
                    orgId: 1
                    folder: ''
                    type: file
                    disableDeletion: false
                    editable: true
                    options:
                      path: /var/lib/grafana/dashboards/default
              
              dashboards:
                default:
                  kubernetes-cluster:
                    gnetId: 7249
                    revision: 1
                    datasource: Prometheus
                  kubernetes-pods:
                    gnetId: 6417
                    revision: 1
                    datasource: Prometheus
                  node-exporter:
                    gnetId: 1860
                    revision: 27
                    datasource: Prometheus
            
            alertmanager:
              alertmanagerSpec:
                storage:
                  volumeClaimTemplate:
                    spec:
                      accessModes: ["ReadWriteOnce"]
                      resources:
                        requests:
                          storage: 5Gi      
      destination:
        server: '{{server}}'
        namespace: monitoring
      
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true
        - ServerSideApply=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m